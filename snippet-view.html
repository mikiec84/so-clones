<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>SOCloneViz</title>

    <link rel="stylesheet" type="text/css" href="global.css"/>

    <script src="lib/d3/d3.min.js"></script>
    <script src="lib/marked/marked.min.js"></script>
</head>
<body>

<div class="header">
    <label for="hash-value">Hash: </label>
    <input id="hash-value"/>
    <button type="button" id="load-hash">Load</button>
    <div class="divider"></div>
    <button type="button" id="previous">< Previous</button>
    <button type="button" id="next">Next ></button>
</div>

<div class="header">
    <div class="markdown-caption">Snippet:</div>
    <div id="post-list-caption" class="post-list-caption">Posts:</div>
</div>

<div id="markdown-content" class="markdown"></div>
<div id="post-list" class="post-list"></div>

<script>
    function errorMessage(errorMessage) {
        alert(errorMessage);
        throw new Error(errorMessage);
    }

    var queryParameters = [];
    var snippetMetadata;
    var posts;
    var currentIndex;
    var loadHashButton = d3.select("#load-hash");
    var nextButton = d3.select("#next");
    var previousButton = d3.select("#previous");
    var hashInput = document.getElementById("hash-value");
    var markdownContent = document.getElementById("markdown-content")
    var postListDiv = d3.select("#post-list");
    var postListCaption = document.getElementById("post-list-caption");

    // read query parameters
    window.location.search.substr(1).split("&").forEach(function(keyValueString) {
        var keyValue = keyValueString.split("=");
        queryParameters[keyValue[0]] = keyValue[1];
    });

    if (!Object.keys(queryParameters).includes("hashValue")) {
        errorMessage("Query parameter hashValue is missing.");
    }

    // set hash value
    hashInput.value = queryParameters["hashValue"];

    // register event handlers
    loadHashButton.on("click", function() {
        if (loadMetadata()) {
            updateView();
        }
    });

    nextButton.on("click", function() {
        if (currentIndex < snippetMetadata.length-1) {
            currentIndex++;
            hashInput.value = snippetMetadata[currentIndex].HashValue;
            if (loadMetadata()) {
                updateView();
            }
        }
    });

    previousButton.on("click", function() {
        if (currentIndex > 0) {
            currentIndex--;
            hashInput.value = snippetMetadata[currentIndex].HashValue;
            if (loadMetadata()) {
                updateView();
            }
        }
    });

    // read index file
    d3.csv("data/index.csv", function (row, index) {
        return {
            Index: index,
            HashValue: row.HashValue,
            ThreadCount: parseInt(row.ThreadCount),
            LineCount: parseInt(row.LineCount)
        }
    }).then(function(data) {
        snippetMetadata = data;

        if (loadMetadata()) {
            updateView();
        }
    });

    function getStackOverflowUrl(post, onlySuffix) {
        var suffix;
        if (post.PostTypeId === 1) {
            suffix = "q/" + post.PostId;
        } else if (post.PostTypeId === 2) {
            suffix = "a/" + post.PostId;
        } else {
            errorMessage("Invalid PostTypeId " + post.PostTypeId);
        }
        if (onlySuffix) {
            return suffix;
        } else {
            return "https://stackoverflow.com/" + suffix;
        }
    }

    function prepareContent(content) {
        return content
            .split("&#xD;&#xA;")
            .map(function(line) {
                var result = line.replace(new RegExp("\t", "g"), "");
                while (!result.startsWith("    ")) {
                    result = " " + result;
                }
                return result;
            })
            .join("\n");
    }

    function loadMetadata() {
        var row = snippetMetadata.find(function(row) { return row.HashValue === hashInput.value.trim() });

        if (row == null) {
            errorMessage("Hash value not found.");
            return false;
        }

        currentIndex = row.Index;

        // update buttons
        if (currentIndex < snippetMetadata.length-1) {
            nextButton.attr("disabled", null);
        } else {
            nextButton.attr("disabled", "disabled");
        }
        if (currentIndex > 0) {
            previousButton.attr("disabled", null);
        } else {
            previousButton.attr("disabled", "disabled");
        }

        return true;
    }

    function updateView() {
        loadSnippet();
        loadPosts();
    }

    function loadSnippet() {
        d3.csv("data/" + hashInput.value.trim() + "_content.csv", function (row) {
            return {
                Content: prepareContent(row.Content)
            }
        }).then(function(data) {
            markdownContent.innerHTML = marked(data[0].Content);
        });
    }

    function loadPosts() {
        d3.csv("data/" + hashInput.value.trim() + ".csv", function (row) {
            return {
                PostId: parseInt(row.PostId),
                PostTypeId: parseInt(row.PostTypeId),
                ParentId: parseInt(row.ParentId)
            }
        }).then(function(data) {
            posts = data;
            postListCaption.innerText = "Posts (" + posts.length + "):";

            postListDiv
                .select("*")
                .remove();

            postListDiv
                .selectAll("div")
                .data(posts)
                .enter()
                .append("div")
                .append("a")
                .attr("href", function(post) {
                    return getStackOverflowUrl(post);
                })
                .text(function(post) {
                    return getStackOverflowUrl(post, true);
                })
                .attr("target", "_blank");
        });
    }

</script>

</body>
</html>